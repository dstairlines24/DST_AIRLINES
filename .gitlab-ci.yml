variables:
  REGISTRY: "docker.io"
  APP_IMAGE: "guillaumegossmann/dst_airlines_app"
  APP_ADMIN_IMAGE: "guillaumegossmann/dst_airlines_app_admin"
  APP_FORM_IMAGE: "guillaumegossmann/dst_airlines_app_form"
  APP_DASH_IMAGE: "guillaumegossmann/dst_airlines_app_dash"
  IP_VM: 127.0.0.1
  PORT_DEV_APP: 5002
  PORT_DEV_APP_FORM: 5001
  PORT_DEV_APP_ADMIN: 5000
  PORT_DEV_APP_ADMIN_JUPYTER: 8888
  PORT_DEV_APP_DASH: 8051
  PORT_PROD_APP: 15002
  PORT_PROD_APP_FORM: 15001
  PORT_PROD_APP_ADMIN: 15000
  PORT_PROD_APP_ADMIN_JUPYTER: 18888
  PORT_PROD_APP_DASH: 18051
  # DOCKER_DRIVER: overlay2
  
image:
  name: "python:3.9-slim"
  entrypoint: [""]
  # entrypoint: ["/bin/sh", "-c"] # Pour les versions de Docker avant 17

stages:
  - test
  - build
  - deploy-dev
  - deploy-prod

.do_strategy:
  before_script:
    - whoami  # Affiche l'utilisateur courant
    - id  # Affiche l'UID et le GID de l'utilisateur
  variables:
    GIT_STRATEGY: fetch
    GIT_CLEAN_FLAGS: -ffdx -e data/ -e app_admin/scripts/.ipynb_checkpoints/ -e app_admin/__pycache__/ -e app_admin/scripts/__pycache__/ -e app/__pycache__/ -e app_dash/__pycache__/ -e app_form/__pycache__/ -e app_form/scripts/__pycache__/ -e functions/__pycache__ -e model/__pycache__

# test:
#   stage: test
#   tags:
#     - test-mongo
#   services:
#     - name: mongo:4.4
#       alias: mongodb
#   variables:
#       MONGO_HOST: IP_VM
#       MONGO_PORT: 27017
#       MONGO_INITDB_DATABASE: test_db
#       DOCKER_NETWORK_MODE: "host"
#       MONGO_INITDB_ROOT_USERNAME: root
#       MONGO_INITDB_ROOT_PASSWORD: root
#       MONGO_INITDB_DATABASE: app_data
#       MONGO_URI: mongodb://mongodb:27017/app_data?authSource=admin
#   script:
#     - pwd
#     - echo "Checking DNS configuration"
#     - cat /etc/resolv.conf
#     - echo "Listing hosts"
#     - cat /etc/hosts
#     - pip install --upgrade pip
#     - apt-get update
#     - pip install -r app/requirements.txt
#     - python3 init_db2.py

    # - sudo chmod -R 755 data
    # - nc -zv mongodb 27017
    # - echo "MongoDB est accessible sur $MONGO_HOST:$MONGO_PORT"
    # - >
    #   until nc -zv mongodb 27017; do
    #     echo "Waiting for MongoDB to be available..."
    #     sleep 5
    #   done
    # - nc -zv mongodb 27017 || exit 1 # Attente que MongoDB soit prêt
    # - python3 -m unittest discover tests/
    # - python -m unittest discover -s app/tests -p "*.py"

    # - ping -c 4 mongodb
    # - sudo chmod -R 777 data
    # - mongosh $MONGODB_URI
    # - nc -zv mongodb 27017

test-app:
  stage: test
  rules:
    - changes:
        - app/*
        - data_test/*
        - model/*
  tags:
    - test-mongo
  services:
    - name: mongo:4.4
      alias: mongodb
  variables:
    MONGO_INITDB_ROOT_USERNAME: root
    MONGO_INITDB_ROOT_PASSWORD: root
    MONGO_URI: mongodb://root:root@mongodb:27017/app_data?authSource=admin
    FLASK_ADMIN_LOGIN: admin
    FLASK_ADMIN_PASSWORD: admin
    FLASK_USER_LOGIN: dstairlines
    FLASK_USER_PASSWORD: dstairlines
    API_KEY: api_key_dstairlines
  extends: .do_strategy
  script:
    - cp -r data_test app/data_test
    - cp -r model app/model
    - cd app/
    - pip install --upgrade pip
    - apt-get update
    - pip install -r requirements.txt
    - pip install pytest
    - pip install --upgrade pyOpenSSL
    - python3 ../init_db.py
    # - python3 -m pytest tests/

test-app_admin:
  stage: test
  rules:
    - changes:
        - app_admin/*
        - data_test/*
        - model/*
        - functions/*
  script:
    - cd app_admin/
    - sudo pip install --upgrade pip
    - sudo apt-get update
    - pip install -r requirements.txt

test-app_form:
  stage: test
  rules:
    - changes:
        - app_form/*
        - data_test/*
        - functions/*
  script:
    - cd app_form/
    - sudo pip install --upgrade pip
    - sudo apt-get update
    - pip install -r requirements.txt

.do_dind:
  services:
    - docker:dind

.do_docker_logging:
  before_script:
    - whoami  # Affiche l'utilisateur courant
    - id  # Affiche l'UID et le GID de l'utilisateur
    - echo "======== before_script start ========"
    - if [ -z "$DOCKER_USERNAME" ] || [ -z "$DOCKER_PASSWORD" ]; then echo "Docker credentials not set"; exit 1; fi
    - echo "Logging in to Docker..."
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - echo "======== before_script end ========" 

build-app:
  stage: build
  image: docker:latest
  rules:
    - changes:
        - app/*
  extends: 
    - .do_dind
    - .do_strategy
    - .do_docker_logging
  script:
    - cd app/
    - docker build -f Dockerfile -t $APP_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag $APP_IMAGE:$CI_COMMIT_SHORT_SHA $APP_IMAGE:latest
    - docker push $APP_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $APP_IMAGE:latest

build-app_admin:
  stage: build
  image: docker:latest
  rules:
    - changes:
        - app_admin/*
  extends: 
    - .do_dind
    - .do_strategy
    - .do_docker_logging
  script:
    - cd app_admin/
    - docker build -f Dockerfile -t $APP_ADMIN_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag $APP_ADMIN_IMAGE:$CI_COMMIT_SHORT_SHA $APP_ADMIN_IMAGE:latest
    - docker push $APP_ADMIN_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $APP_ADMIN_IMAGE:latest

build-app_dash:
  stage: build
  image: docker:latest
  rules:
    - changes:
        - app_dash/*
  extends: 
    - .do_dind
    - .do_strategy
    - .do_docker_logging
  script:
    - cd app_dash/
    - docker build -f Dockerfile -t $APP_DASH_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag $APP_DASH_IMAGE:$CI_COMMIT_SHORT_SHA $APP_DASH_IMAGE:latest
    - docker push $APP_DASH_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $APP_DASH_IMAGE:latest

build-app_form:
  stage: build
  image: docker:latest
  rules:
    - changes:
        - app_form/*
  extends: 
    - .do_dind
    - .do_strategy
    - .do_docker_logging
  script:
    - cd app_form/
    - docker build -f Dockerfile -t $APP_FORM_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag $APP_FORM_IMAGE:$CI_COMMIT_SHORT_SHA $APP_FORM_IMAGE:latest
    - docker push $APP_FORM_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $APP_FORM_IMAGE:latest

stop-dev:
  stage: deploy-dev
  extends: .do_strategy
  variables:
    NAMESPACE: dev
  when: manual
  # Don't stop the "review" for master branch or tags,
  # it is only for branches (so PRs (most of the time))
  environment:
    name: $NAMESPACE-$CI_BUILD_REF_NAME
    action: stop
  script:
    - docker-compose down

deploy-dev:
  stage: deploy-dev
  image: docker:latest
  extends: 
    - .do_dind
    - .do_strategy
    - .do_docker_logging
  variables:
    NAMESPACE: dev
  # services:
  #   - name: docker:dind
  #     command: ["--host=tcp://0.0.0.0:2375"]
  # variables:
  #   DOCKER_HOST: unix:///var/run/docker.sock 
  #   DOCKER_HOST: tcp://docker:2375 
  #   DOCKER_TLS_CERTDIR: "/certs"
  #   DOCKER_DRIVER: overlay2
  #   DOCKER_TLS_CERTDIR: ""
  environment:
    name: $NAMESPACE-$CI_BUILD_REF_NAME
    url: |
      http://$IP_VM:$PORT_DEV_APP
      http://$IP_VM:$PORT_DEV_APP_FORM
      http://$IP_VM:$PORT_DEV_APP_ADMIN
      http://$IP_VM:$PORT_DEV_APP_ADMIN_JUPYTER
      http://$IP_VM:$PORT_DEV_APP_DASH
    on_stop: stop-dev
  script:
    - sudo chmod -R 755 data
    # - sudo chown -R gitlab-runner:gitlab-runner .
    - ls -lR
    - pwd
    - echo "Vérification de docker-compose"
    - docker-compose --version
    # - docker-compose config 
    - echo "Démarrage des services avec docker-compose"
    # - docker-compose -f docker-compose.yml up --pull always -d
    - docker-compose down
    - docker-compose up
    - echo "Affichage des logs de docker-compose"
    - docker-compose logs
    - echo "Liste des conteneurs Docker"
    - docker info
    - docker ps

deploy-prod:
  stage: deploy-prod
  image: docker:latest
  extends: 
    - .do_dind
    - .do_strategy
    - .do_docker_logging
  environment:
    name: prod-$CI_BUILD_REF_NAME
    url: |
      http://$IP_VM:$PORT_PROD_APP
      http://$IP_VM:$PORT_PROD_APP_FORM
      http://$IP_VM:$PORT_PROD_APP_ADMIN
      http://$IP_VM:$PORT_PROD_APP_ADMIN_JUPYTER
      http://$IP_VM:$PORT_PROD_APP_DASH
  when: manual
  only:
    - main
  script:
    - ls -R
    - pwd
    - echo "Vérification de docker-compose"
    - docker-compose --version
    - echo "Démarrage des services avec docker-compose"
    - docker-compose up
    - echo "Affichage des logs de docker-compose"
    - docker-compose logs
    - echo "Liste des conteneurs Docker"
    - docker info
    - docker ps